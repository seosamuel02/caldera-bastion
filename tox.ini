[tox]
skipsdist = True
envlist =
    py{39,310,311,312}
    style
    coverage
skip_missing_interpreters = true

[testenv]
description = Run unit tests with pytest
passenv =
    TOXENV
    CI
    GITHUB_*
deps =
    virtualenv!=20.0.22
    pre-commit
    pytest
    pytest-asyncio>=0.23.0
    pytest-aiohttp
    pytest-cov
    coverage
    aiohttp
    pyyaml
    python-dateutil
    opensearch-py>=2.0.0
changedir = {toxinidir}
setenv =
    PYTHONPATH = {toxinidir}:{toxinidir}/../../../
commands =
    coverage run -p -m pytest --tb=short --asyncio-mode=auto tests/ -W ignore::DeprecationWarning -v

[testenv:style]
description = Check code style with pre-commit
deps = pre-commit
skip_install = true
changedir = {toxinidir}
commands = pre-commit run --all-files --show-diff-on-failure

[testenv:coverage]
description = Generate coverage report
deps = coverage
skip_install = true
changedir = {toxinidir}
commands =
    coverage combine
    coverage html
    coverage report --fail-under=70

[testenv:lint]
description = Run flake8 linter
deps = flake8
skip_install = true
changedir = {toxinidir}
commands = flake8 app/ hook.py --max-line-length=120 --ignore=E501,W503

[pytest]
asyncio_mode = auto
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --tb=short
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning

[coverage:run]
source = app, hook
omit =
    tests/*
    */__pycache__/*
    */conftest.py

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise NotImplementedError
    if __name__ == .__main__.:
    pass
show_missing = true
